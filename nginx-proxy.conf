# Nginx reverse proxy for OKX API
#
# Setup:
# 1. Create password file: htpasswd -c /etc/nginx/.htpasswd your_username
# 2. Copy this file to /etc/nginx/sites-available/okx-proxy
# 3. ln -s /etc/nginx/sites-available/okx-proxy /etc/nginx/sites-enabled/
# 4. nginx -t && systemctl reload nginx
#
# Usage from Worker:
#   fetch('https://your-vps.com/okx/api/v5/market/index-components?index=BTC-USDT', {
#     headers: { 'Authorization': 'Basic ' + btoa('username:password') }
#   })

server {
    listen 443 ssl http2;
    server_name your-vps.com;  # Replace with your domain

    # SSL certificates (use certbot for Let's Encrypt)
    ssl_certificate /etc/letsencrypt/live/your-vps.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-vps.com/privkey.pem;

    # Basic auth
    auth_basic "Restricted";
    auth_basic_user_file /etc/nginx/.htpasswd;

    # Proxy to OKX API
    location /okx/ {
        # Remove /okx prefix when forwarding
        rewrite ^/okx/(.*) /$1 break;

        proxy_pass https://www.okx.com;
        proxy_ssl_server_name on;
        proxy_set_header Host www.okx.com;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Don't pass auth header to OKX
        proxy_set_header Authorization "";

        # Timeouts
        proxy_connect_timeout 30s;
        proxy_read_timeout 30s;
    }
}

# Redirect HTTP to HTTPS
server {
    listen 80;
    server_name your-vps.com;
    return 301 https://$server_name$request_uri;
}
